{{- /* ==================== Vim Core ==================== */ -}}
{{- /* This template handles vim-plug auto-install with mirror fallback.
        - Follows official behavior: download if missing, then auto-run PlugInstall on VimEnter.
        - Uses silent curl with fallback mirrors.
        - Depends on s:vim_data_dir defined in common/core.
     */ -}}

" ---------- Ensure vim data directory is defined ----------
if !exists('s:vim_data_dir')
  if has('win32')
    let s:vim_data_dir = expand('~/vimfiles')
  else
    let s:vim_data_dir = exists('$XDG_DATA_HOME') ?
          \ $XDG_DATA_HOME . '/vim' :
          \ expand('~/.local/share/vim')
  endif
endif

" ---------- Auto-install vim-plug with mirror fallback ----------
let s:plug_target = s:vim_data_dir . '/autoload/plug.vim'

if empty(glob(s:plug_target))
  " Mirror list in order of preference
  let s:urls = [
        \ 'https://raw.gitcode.com/gh_mirrors/vi/vim-plug/raw/master/plug.vim',
        \ 'https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim',
        \ 'https://gitee.com/wei_hongjie/vim-plug/raw/master/plug.vim'
        \ ]

  for url in s:urls
    if has('win32')
      silent execute '!curl.exe -s -fLo ' . shellescape(s:plug_target) . ' --create-dirs ' . url
    else
      silent execute '!curl -s -fLo ' . shellescape(s:plug_target) . ' --create-dirs ' . url
    endif
    if v:shell_error == 0
      break
    endif
  endfor

  " If any mirror succeeded, schedule plugin installation (official behavior)
  if v:shell_error == 0
    autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
  endif
endif
